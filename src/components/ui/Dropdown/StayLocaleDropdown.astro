---
import { getCollection } from "astro:content";
import BaseSelectDropdown from "./BaseSelectDropdown.astro";

// Get the current country and locale from the URL
const currentCountry = Astro.url.pathname.split("/")[2];
const currentLocale = Astro.url.pathname.split("/")[3];

const stays = await getCollection("stays");

// Filter stays to include only those that are assigned to the current country
const filteredStays = stays.filter((stay) => {
  const countries = Array.isArray(stay.data.properties.sCountry)
    ? stay.data.properties.sCountry.map((c) =>
        c.toLowerCase().replace(/\s+/g, "-")
      )
    : [String(stay.data.properties.sCountry).toLowerCase().replace(/\s+/g, "-")];

  return countries.includes(currentCountry);
});

// Count the number of stays for each locale within the current country
const localeCounts = filteredStays.reduce((acc: Record<string, number>, stay) => {
  const countries = Array.isArray(stay.data.properties.sCountry)
    ? stay.data.properties.sCountry.map((c) =>
        c.toLowerCase().replace(/\s+/g, "-")
      )
    : [String(stay.data.properties.sCountry).toLowerCase().replace(/\s+/g, "-")];

  const locales = Array.isArray(stay.data.properties.sLocale)
    ? stay.data.properties.sLocale
    : [stay.data.properties.sLocale];

  if (countries.includes(currentCountry)) {
    locales.forEach((locale) => {
      if (locale) {
        acc[locale] = (acc[locale] || 0) + 1;
      }
    });
  }

  return acc;
}, {});

// Extract unique locales and sort alphabetically
const uniqueLocales = Object.keys(localeCounts).sort();

// Transform to items array for BaseSelectDropdown
const items = uniqueLocales.map((locale) => {
  const localeSlug = locale.toLowerCase().replace(/\s+/g, "-");
  return {
    name: locale,
    count: localeCounts[locale],
    slug: localeSlug,
    url: `/stays/${currentCountry}/${localeSlug}`,
  };
});
---

<BaseSelectDropdown
  items={items}
  currentItem={currentLocale}
  placeholder="Locales"
  id="stay-locales"
  showCrawlerLinks={true}
  crawlerLinkText={(name) => `${name} stays in ${currentCountry}`}
/>