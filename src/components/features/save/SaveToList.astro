---
import Button from '../../ui/Button.astro';

/*
  Props:
    - itemType: 'project' | 'stay'
    - itemId: string

  Usage:
    <SaveToList itemType="project" itemId="test-project-123" />
*/
const { itemType = 'project', itemId = '', variant = 'panel', mobileShowLabel = false, mobileFullWidth = false } = Astro.props;
---

<div id={"save-root-" + itemId} data-item-id={itemId} data-item-type={itemType} class={variant === 'minimal' ? 'hidden pb-3 border-b border-white/10' : 'hidden bg-white border border-gray-200 rounded-lg p-6 dark:bg-gray-800 dark:border-gray-700'}>
  {variant !== 'minimal' && (
    <div class="mb-4">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Save</h3>
      <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Save this {itemType} to your personal lists to revisit later.</p>
    </div>
  )}
  <div class="flex gap-3 w-full max-w-full overflow-hidden">
    <!-- Save trigger (50%) -->
    <div class="flex-1 min-w-0">
      <button
        id={"save-btn-" + itemId}
        type="button"
        aria-expanded="false"
        aria-controls={"save-panel-" + itemId}
        title="Save to a list"
        class="w-full px-4 py-2.5 text-sm font-semibold rounded-lg transition-all duration-300 flex items-center justify-center gap-2 cursor-pointer hover:shadow-md"
        style="border: 2px solid #1C2434; color: #1C2434; background: white;"
      >
        <!-- Save icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-5 h-5" viewBox="0 0 16 16">
          <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
        </svg>
        <span id={"save-label-" + itemId} class={variant === 'minimal' ? (mobileShowLabel ? '' : 'hidden sm:inline') : ''}>Save</span>
      </button>
    </div>

    <!-- Visited toggle (50%) -->
    <div class="flex-1 min-w-0">
      <button
        id={"done-btn-" + itemId}
        type="button"
        aria-pressed="false"
        aria-label="Mark as visited"
        title="Mark as visited"
        class="w-full px-4 py-2.5 text-sm font-semibold rounded-lg flex items-center justify-center gap-2 cursor-pointer hover:shadow-md"
        style="border: 2px solid #1C2434; color: #1C2434; background: white; transition: box-shadow 0.3s ease;"
      >
        <!-- Visited icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-5 h-5" viewBox="0 0 16 16" style="display: block;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
          <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
        </svg>
        <span id={"done-label-" + itemId}>Visited</span>
      </button>
    </div>
  </div>

  <div id={"actions-msg-" + itemId} class="mt-2 text-sm" aria-live="polite"></div>

  <!-- Inline panel -->
  <div id={"save-panel-" + itemId} class={variant === 'minimal' ? 'hidden mt-3 p-5 bg-white rounded-xl shadow-lg dark:bg-gray-800' : 'hidden mt-3 p-5 bg-white rounded-xl shadow-lg dark:bg-gray-800'} style="border: 1px solid #E8EAE8;">
    <div class="flex items-center justify-between mb-4">
      <h3 id={"save-modal-title-" + itemId} class="text-base font-bold dark:text-white" style="color: #1C2434;">Your Lists</h3>
      <span class="text-xs" style="color: #7E827E;">Select lists to save</span>
    </div>

    <div id={"lists-area-" + itemId} class="lists-area text-sm" style="color: #7E827E;">Loading lists…</div>

    <!-- New list button (shown when user has lists) -->
    <button 
      type="button"
      id={"new-list-toggle-" + itemId}
      class="hidden mt-4 w-full px-4 py-2.5 text-sm font-semibold rounded-lg cursor-pointer transition-all duration-200 flex items-center justify-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-700"
      style="border: 2px dashed #E8EAE8; color: #7E827E; background: white;"
      aria-expanded="false"
      aria-controls={"create-form-" + itemId}
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      <span>New list</span>
    </button>

    <!-- Create form (always visible when no lists, toggle-able when lists exist) -->
    <form id={"create-form-" + itemId} class="mt-4 flex flex-col sm:flex-row sm:items-center gap-2">
      <input id={"new-title-" + itemId} placeholder="New list title" class="flex-1 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 dark:bg-gray-900 dark:text-gray-100 transition-all duration-300" style="border: 2px solid #E8EAE8; color: #1C2434; font-size: 16px;" />
      <button type="submit" class="w-full sm:w-auto px-4 py-2 text-sm font-semibold rounded-lg cursor-pointer transition-all duration-300 hover:shadow-lg" style="background-color: #1C2434; color: white;">Create</button>
    </form>

    <div id={"msg-" + itemId} class="msg mt-2 text-sm" aria-live="polite"></div>
  </div>
</div>

<!-- Import the external client script -->
<script src="/src/components/features/save/saveToList.client.js"></script>

<style>
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
  
  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>

<script is:inline>
// Client-side SaveToList functionality for static builds
(async function() {
  // Wait for the API to be available
  while (!window.SaveToListAPI) {
    await new Promise(resolve => setTimeout(resolve, 10));
  }
  
  const {
    getCurrentUser,
    getLists,
    getListsContainingItem,
    saveItemToList,
    removeItemFromList,
    createList,
    getCompletedStatus,
    setCompleted
  } = window.SaveToListAPI;
  
  // Helper functions for the component

  async function initSave(root) {
    // prevent duplicate init in HMR
    if (root?.dataset?.saveBound === '1') return;
    root.dataset.saveBound = '1';

    console.log('Initializing SaveToList for:', root);

    // Check authentication - only show component to authenticated users
    const user = await getCurrentUser();
    if (!user) {
      console.log('SaveToList: No authenticated user, hiding component');
      root.style.display = 'none';
      return;
    }
    
    // User is authenticated, show the component
    console.log('SaveToList: User authenticated, showing component');
    root.classList.remove('hidden');

    const itemIdStr = root?.dataset?.itemId || '';
    const itemTypeStr = root?.dataset?.itemType || 'project';

    const $ = (sel) => root.querySelector(sel);
    const byId = (id) => document.getElementById(id);

    if (!itemIdStr) {
      const btn = $('[id^="save-btn-"]');
      const doneBtn = $('[id^="done-btn-"]');
      const listsArea = $('[id^="lists-area-"]');
      const msgEl = $('[id^="msg-"]');
      const actionsMsg = $('[id^="actions-msg-"]');
      if (btn) {
        btn.setAttribute('disabled', 'true');
        btn.setAttribute('aria-disabled', 'true');
        btn.title = 'Save unavailable (missing item id)';
        btn.style.opacity = '0.6';
        btn.style.pointerEvents = 'none';
        btn.style.backgroundColor = 'white';
        btn.style.color = '#1C2434';
        btn.style.border = '2px solid #1C2434';
      }
      if (doneBtn) {
        doneBtn.setAttribute('disabled', 'true');
        doneBtn.setAttribute('aria-disabled', 'true');
        doneBtn.title = 'Visited unavailable (missing item id)';
        doneBtn.style.opacity = '0.6';
        doneBtn.style.pointerEvents = 'none';
        doneBtn.style.backgroundColor = 'white';
        doneBtn.style.color = '#1C2434';
        doneBtn.style.border = '2px solid #1C2434';
      }
      if (listsArea) listsArea.textContent = 'Save unavailable: missing item id.';
      if (msgEl) msgEl.textContent = '';
      if (actionsMsg) actionsMsg.textContent = '';
      return;
    }

    // scoped references
    const btn = $(`#save-btn-${itemIdStr}`);
    const panel = $(`#save-panel-${itemIdStr}`);
    const listsArea = $(`#lists-area-${itemIdStr}`);
    const msgEl = $(`#msg-${itemIdStr}`);
    const doneBtn = $(`#done-btn-${itemIdStr}`);
    const actionsMsg = $(`#actions-msg-${itemIdStr}`);
    const createForm = $(`#create-form-${itemIdStr}`);
    const newTitle = $(`#new-title-${itemIdStr}`);
    const newListToggle = $(`#new-list-toggle-${itemIdStr}`);

    console.log('SaveToList elements found:', { 
      btn: !!btn, 
      panel: !!panel, 
      doneBtn: !!doneBtn,
      itemId: itemIdStr 
    });

    // Initialize button styles immediately (default state)
    if (btn) {
      btn.style.backgroundColor = 'white';
      btn.style.color = '#1C2434';
      btn.style.border = '2px solid #1C2434';
    }
    if (doneBtn) {
      doneBtn.style.backgroundColor = 'white';
      doneBtn.style.color = '#1C2434';
      doneBtn.style.border = '2px solid #1C2434';
    }

    function updateSaveButtonIcon() {
      try {
        const label = byId('save-label-' + itemIdStr);
        const isSaved = savedSet && savedSet.size > 0;
        
        if (btn) {
          btn.title = isSaved ? 'Saved to your lists' : 'Save to a list';
        }
        if (label) {
          label.textContent = isSaved ? 'Saved' : 'Save';
        }
        // Update button styling
        if (btn) {
          if (isSaved) {
            // Active/Saved state: Light purple background
            btn.style.backgroundColor = '#C4B3FC';
            btn.style.color = '#1C2434';
            btn.style.border = '2px solid #A98FFA';
          } else {
            // Default state: White with dark border
            btn.style.backgroundColor = 'white';
            btn.style.color = '#1C2434';
            btn.style.border = '2px solid #1C2434';
          }
        }
      } catch (e) {
        console.error('Error updating save button icon:', e);
      }
    }

    let lists = [];
    let savedSet = new Set();
    const loadingMap = {};

    // preload saved + done state
    (async () => {
      try {
        const containing = await getListsContainingItem(itemTypeStr, itemIdStr);
        savedSet = new Set((containing || []).map((l) => l.id));
        updateSaveButtonIcon();
      } catch (e) {
        console.error('Error loading saved state:', e);
      }
      try {
        const status = await getCompletedStatus(itemTypeStr, itemIdStr);
        setDoneButtonVisual(!!(status && status.is_completed));
      } catch (e) {
        console.error('Error loading completed state:', e);
      }
    })();

    function togglePanel(show) {
      if (!panel) return;
      const shouldShow = typeof show === 'boolean' ? show : panel.classList.contains('hidden');
      if (shouldShow) {
        panel.classList.remove('hidden');
        if (btn) btn.setAttribute('aria-expanded', 'true');
      } else {
        panel.classList.add('hidden');
        if (btn) btn.setAttribute('aria-expanded', 'false');
        showMessage('');
      }
    }

    function setDoneButtonVisual(isDone) {
      if (!doneBtn) return;
      doneBtn.setAttribute('aria-pressed', String(isDone));
      
      // Temporarily disable transitions to prevent glitching
      doneBtn.style.transition = 'none';
      
      // Update button appearance using inline styles
      if (isDone) {
        // Active/Visited state: Light purple background
        doneBtn.style.backgroundColor = '#C4B3FC';
        doneBtn.style.color = '#1C2434';
        doneBtn.style.border = '2px solid #A98FFA';
      } else {
        // Default state: White with dark border
        doneBtn.style.backgroundColor = 'white';
        doneBtn.style.color = '#1C2434';
        doneBtn.style.border = '2px solid #1C2434';
      }
      
      doneBtn.title = isDone ? 'Marked as visited' : 'Mark as visited';
      
      // Re-enable transitions after a brief delay
      setTimeout(() => {
        if (doneBtn) {
          doneBtn.style.transition = '';
        }
      }, 50);
    }

    function showMessage(txt, isError = false) {
      if (!msgEl) return;
      msgEl.classList.remove('text-red-600');
      if (isError && txt) {
        msgEl.textContent = txt;
        msgEl.classList.add('text-red-600');
      } else {
        msgEl.textContent = '';
      }
    }

    async function refreshLists() {
      if (!listsArea) return;
      listsArea.textContent = 'Loading lists…';
      try {
        lists = await getLists();
        const containing = await getListsContainingItem(itemTypeStr, itemIdStr);
        savedSet = new Set((containing || []).map((l) => l.id));
        renderListCheckboxes();
        updateSaveButtonIcon();
      } catch (err) {
        const errMsg = (err && (err.message || err.error || JSON.stringify(err))) || String(err);
        listsArea.textContent = 'Unable to load lists: ' + errMsg;
        console.error('refreshLists error:', err);
      }
    }

    function renderListCheckboxes() {
      if (!listsArea) return;
      
      // Empty state: show form, hide toggle button
      if (!lists || lists.length === 0) {
        listsArea.innerHTML = '<div class="text-sm" style="color: #7E827E;">You have no lists yet. Create your first one below!</div>';
        if (createForm) createForm.classList.remove('hidden');
        if (newListToggle) newListToggle.classList.add('hidden');
        return;
      }
      
      // Has lists: show toggle button, hide form by default
      if (newListToggle) {
        newListToggle.classList.remove('hidden');
      }
      if (createForm && newListToggle?.getAttribute('aria-expanded') !== 'true') {
        createForm.classList.add('hidden');
      }
      
      listsArea.innerHTML = '';
      const group = document.createElement('div');
      group.className = 'rounded-lg overflow-hidden';
      group.style.border = '1px solid #E8EAE8';
      lists.forEach((l, index) => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between gap-3 p-3 bg-white dark:bg-gray-800 hover:bg-gray-50 transition-colors duration-200';
        row.dataset.listId = l.id;
        // Add border-top to all but first item, matching outer border color
        if (index > 0) {
          row.style.borderTop = '1px solid #E8EAE8';
        }

        const left = document.createElement('div');
        left.className = 'flex items-center gap-3';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = 'cb-' + l.id + '-' + itemIdStr;
        cb.checked = savedSet.has(l.id);
        cb.disabled = !!loadingMap[l.id];
        cb.className = 'h-4 w-4 rounded cursor-pointer transition-all duration-300';
        cb.style.borderColor = '#E8EAE8';
        cb.style.accentColor = '#A98FFA';
        cb.addEventListener('change', () => toggleSave(l.id, cb.checked, cb));

        const label = document.createElement('label');
        label.htmlFor = cb.id;
        label.className = 'text-sm cursor-pointer dark:text-gray-100';
        label.style.color = '#1C2434';
        label.innerHTML = `${l.title}${l.is_default ? ' <span class="ml-2 text-xs" style="color: #7E827E;">(default)</span>' : ''}`;

        left.appendChild(cb);
        left.appendChild(label);

        const status = document.createElement('span');
        status.className = 'text-xs font-semibold flex items-center gap-1.5 transition-all duration-300';
        status.dataset.listStatus = l.id;
        if (savedSet.has(l.id)) {
          status.style.color = '#10B981'; // Green for saved
          status.innerHTML = `
            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            Saved
          `;
        } else {
          status.style.color = '#A8ACA8';
          status.textContent = '';
        }

        row.appendChild(left);
        row.appendChild(status);
        group.appendChild(row);
      });
      listsArea.appendChild(group);
    }

    async function toggleSave(listId, shouldSave, cbEl) {
      loadingMap[listId] = true;
      cbEl.disabled = true;
      showMessage('');
      
      const row = listsArea?.querySelector(`[data-list-id="${listId}"]`);
      const status = row?.querySelector('[data-list-status]');
      
      // Show loading spinner
      if (status) {
        status.style.color = '#A98FFA';
        status.innerHTML = `
          <svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          ${shouldSave ? 'Saving…' : 'Removing…'}
        `;
      }
      
      try {
        // Add minimum delay to ensure user sees the loading state
        const actionPromise = shouldSave 
          ? saveItemToList(listId, itemTypeStr, itemIdStr)
          : removeItemFromList(listId, itemTypeStr, itemIdStr);
        
        const minDelay = new Promise(resolve => setTimeout(resolve, 400));
        await Promise.all([actionPromise, minDelay]);
        
        if (shouldSave) {
          savedSet.add(listId);
          // Show success state with animation
          if (status) {
            status.style.color = '#10B981';
            status.innerHTML = `
              <svg class="w-3.5 h-3.5 animate-bounce-once" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true" style="animation: bounce-once 0.5s ease-out;">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              Saved
            `;
          }
        } else {
          savedSet.delete(listId);
          if (status) {
            status.style.color = '#A8ACA8';
            status.textContent = '';
          }
        }
      } catch (err) {
        cbEl.checked = !shouldSave;
        showMessage(err && err.message ? err.message : String(err), true);
        console.error(err);
        // Reset status on error
        if (status) {
          if (savedSet.has(listId)) {
            status.style.color = '#10B981';
            status.innerHTML = `
              <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              Saved
            `;
          } else {
            status.style.color = '#A8ACA8';
            status.textContent = '';
          }
        }
      } finally {
        loadingMap[listId] = false;
        cbEl.disabled = false;
        updateSaveButtonIcon();
      }
    }

    if (createForm) {
      createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = (newTitle?.value || '').trim();
        if (!title) return showMessage('Enter a list title', true);
        try {
          const created = await createList(title);
          lists.push(created);
          await saveItemToList(created.id, itemTypeStr, itemIdStr);
          savedSet.add(created.id);
          if (newTitle) newTitle.value = '';
          renderListCheckboxes();
          updateSaveButtonIcon();
          showMessage('List created and item saved!');
        } catch (err) {
          showMessage(err && err.message ? err.message : String(err), true);
          console.error(err);
        }
      });
    }

    // Toggle new list form visibility
    if (newListToggle) {
      newListToggle.addEventListener('click', () => {
        const isExpanded = newListToggle.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
          // Collapse
          newListToggle.setAttribute('aria-expanded', 'false');
          if (createForm) createForm.classList.add('hidden');
          if (newTitle) newTitle.value = '';
          showMessage('');
        } else {
          // Expand
          newListToggle.setAttribute('aria-expanded', 'true');
          if (createForm) createForm.classList.remove('hidden');
          if (newTitle) {
            // Focus input after a brief delay for animation
            setTimeout(() => newTitle.focus(), 100);
          }
        }
      });
    }

    if (btn) {
      btn.addEventListener('click', async (e) => {
        console.log('Save button clicked!');
        e.preventDefault();
        e.stopPropagation();
        
        // Check auth on button click
        const user = await getCurrentUser();
        if (!user) {
          showMessage('Please log in to save items to lists.', true);
          return;
        }
        
        if (!panel) return;
        const isHidden = panel.classList.contains('hidden');
        if (isHidden) {
          togglePanel(true);
          await refreshLists();
          if (newTitle) newTitle.focus();
        } else {
          togglePanel(false);
        }
      });

      btn.addEventListener('keydown', async (e) => {
        if (e.key !== 'Enter' && e.key !== ' ') return;
        console.log('Save button key pressed!');
        e.preventDefault();
        if (!panel) return;
        const isHidden = panel.classList.contains('hidden');
        if (isHidden) {
          togglePanel(true);
          await refreshLists();
          if (newTitle) newTitle.focus();
        } else {
          togglePanel(false);
        }
      });
    }

    if (doneBtn) {
      doneBtn.addEventListener('click', async () => {
        console.log('Done button clicked!');
        if (actionsMsg) actionsMsg.textContent = '';
        
        // Check auth on button click
        const user = await getCurrentUser();
        if (!user) {
          if (actionsMsg) {
            actionsMsg.textContent = 'Please log in to mark items as visited.';
            actionsMsg.style.color = '#EF4444';
          }
          return;
        }
        
        const pressed = (doneBtn.getAttribute('aria-pressed') === 'true');
        const next = !pressed;
        const doneLabel = doneBtn.querySelector(`#done-label-${itemIdStr}`);
        const doneIcon = doneBtn.querySelector('svg');
        
        // Show loading state - hide icon and change label
        doneBtn.disabled = true;
        doneBtn.style.opacity = '0.6';
        doneBtn.style.cursor = 'wait';
        if (doneIcon) {
          doneIcon.style.display = 'none';
        }
        if (doneLabel) {
          doneLabel.textContent = next ? 'Marking...' : 'Removing...';
        }
        
        try {
          // Add minimum delay to ensure user sees the loading state
          const actionPromise = setCompleted(itemTypeStr, itemIdStr, next);
          const minDelay = new Promise(resolve => setTimeout(resolve, 400));
          const [res] = await Promise.all([actionPromise, minDelay]);
          
          if (!res || !res.success) {
            // Reset on failure
            doneBtn.disabled = false;
            doneBtn.style.opacity = '1';
            doneBtn.style.cursor = 'pointer';
            if (doneIcon) {
              doneIcon.style.display = '';
            }
            if (doneLabel) {
              doneLabel.textContent = 'Visited';
            }
            setDoneButtonVisual(pressed);
            if (actionsMsg) {
              actionsMsg.textContent = 'Unable to update status.';
              actionsMsg.style.color = '#EF4444';
            }
            return;
          }
          
          // Get updated status
          const status = await getCompletedStatus(itemTypeStr, itemIdStr);
          const finalState = !!(status && status.is_completed);
          
          // Restore button state
          doneBtn.disabled = false;
          doneBtn.style.opacity = '1';
          doneBtn.style.cursor = 'pointer';
          if (doneIcon) {
            doneIcon.style.display = '';
          }
          if (doneLabel) {
            doneLabel.textContent = 'Visited';
          }
          
          // Set final visual state without animation
          setDoneButtonVisual(finalState);
        } catch (err) {
          // Reset on error
          doneBtn.disabled = false;
          doneBtn.style.opacity = '1';
          doneBtn.style.cursor = 'pointer';
          if (doneIcon) {
            doneIcon.style.display = '';
          }
          if (doneLabel) {
            doneLabel.textContent = 'Visited';
          }
          setDoneButtonVisual(pressed);
          if (actionsMsg) {
            actionsMsg.textContent = 'Unable to update status.';
            actionsMsg.style.color = '#EF4444';
          }
          console.error('Done button error:', err);
        }
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && panel && !panel.classList.contains('hidden')) {
        togglePanel(false);
      }
    });
  }

  function initAll() {
    const roots = document.querySelectorAll('[id^="save-root-"][data-item-id]');
    console.log('Found SaveToList roots:', roots.length);
    if (roots && roots.length) {
      roots.forEach((r) => initSave(r));
    } else {
      document.addEventListener('DOMContentLoaded', () => {
        const laterRoots = document.querySelectorAll('[id^="save-root-"][data-item-id]');
        console.log('Found SaveToList roots after DOMContentLoaded:', laterRoots.length);
        laterRoots.forEach((r) => initSave(r));
      });
    }
  }

  initAll();
  
  // Re-initialize after Astro view transitions
  document.addEventListener('astro:page-load', () => {
    console.log('Astro page load detected, re-initializing SaveToList');
    initAll();
  });
})();
</script>
