---
import { getCollection } from 'astro:content';
import ResponsiveImage from '../ui/Image/ResponsiveImage.astro';
import VerificationPill from './VerificationPill.astro';

interface Props {
  slug: string;
}

const { slug } = Astro.props;

// Fetch all projects and find the one with matching slug
// Note: Using getCollection + filter instead of getEntry due to Notion loader compatibility
const allProjects = await getCollection('projects');
const project = allProjects.find(p => p.data.properties.pSlug === slug);

// If project doesn't exist, fail the build with a clear error
if (!project) {
  throw new Error(
    `Project embed error: No project found with slug "${slug}". ` +
    `Please check the slug is correct and the project is published in Notion.`
  );
}

const props = project.data.properties;

// Format location display
const countries = Array.isArray(props.pCountry) ? props.pCountry : [props.pCountry];
const locales = Array.isArray(props.pLocale) ? props.pLocale : [props.pLocale];

const formatLocales = (locales: string[]) => {
  if (locales.length === 0) return '';
  if (locales.length === 1) return locales[0];
  if (locales.length === 2) return `${locales[0]} & ${locales[1]}`;
  return `${locales[0]}, ${locales[1]} & ${locales.length - 2} more`;
};

// Truncate description for excerpt
const getExcerpt = (text: string | null | undefined, maxLength: number = 120) => {
  if (!text) return '';
  const cleanText = text.trim();
  if (cleanText.length <= maxLength) return cleanText;
  return cleanText.substring(0, maxLength).trim() + '...';
};

const excerpt = getExcerpt(props.pReview);
---

<div 
  class="not-prose my-6 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm hover:shadow-md transition-shadow duration-200"
  role="article"
  aria-label={`Featured project: ${props.pTitle}`}
>
  <a 
    href={`/projects/${props.pSlug}/`}
    class="flex flex-row gap-3 sm:gap-4 p-3 sm:p-4 group"
    style="text-decoration: none;"
  >
    {/* Thumbnail */}
    <div class="flex-shrink-0 w-24 sm:w-40 h-24 sm:h-28 overflow-hidden rounded-md bg-gray-200 dark:bg-gray-700">
      <img
        class="w-full h-full object-cover"
        src={props.pImageURL ?? '/giveback-guide-placeholder.jpg'}
        alt=""
        loading="lazy"
      />
    </div>

    {/* Content */}
    <div class="flex-1 min-w-0">
      {/* Location pills */}
      <div class="mb-2 flex items-center flex-wrap gap-1.5">
        {countries
          .filter((country: string) => country !== 'United Kingdom' && country !== 'UK')
          .map((country: string) => (
            <div class="inline-flex items-center gap-1.5">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border border-gray-300 text-gray-700 dark:border-gray-600 dark:text-gray-300">
                {country}
              </span>
              {locales.length > 0 && (
                <span class="text-xs font-medium text-gray-700 dark:text-gray-300">
                  |&nbsp;{formatLocales(locales)}
                </span>
              )}
            </div>
          ))}
      </div>

      {/* Title */}
      <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors line-clamp-2 mb-1">
        {props.pTitle}
      </h3>

      {/* Operator */}
      <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mb-1 sm:mb-2">
        {props.pOrganiser}
      </p>

      {/* Excerpt */}
      {excerpt && (
        <p class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 line-clamp-2 hidden sm:block">
          {excerpt}
        </p>
      )}
    </div>

    {/* Arrow indicator */}
    <div class="flex items-center justify-center flex-shrink-0 w-6 sm:w-8">
      <svg 
        class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400 dark:text-gray-500 group-hover:text-purple-600 dark:group-hover:text-purple-400 group-hover:translate-x-1 transition-all" 
        fill="none" 
        stroke="currentColor" 
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </div>
  </a>
</div>
