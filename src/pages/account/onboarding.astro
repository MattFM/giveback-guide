---
import MainLayout from '../../layouts/MainLayout.astro';
---

<MainLayout 
  title="Welcome"
  headerVariant="transparent"
  headerTheme="dark"
  transition:persist={false}
>
  <!-- Early client-side heuristic redirect if no Supabase auth token found -->
  <script is:inline>
    // Quick check for auth token - if missing, redirect immediately
    // Verify page should have established session before routing here
    try {
      const hasToken = (() => {
        if (typeof window === 'undefined' || !('localStorage' in window)) return false;
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (k && /^sb-.*-auth-token$/.test(k)) {
            const v = localStorage.getItem(k);
            if (v && v !== 'null' && v !== 'undefined') {
              return true;
            }
          }
        }
        return false;
      })();
      
      if (!hasToken) {
        console.warn('[Onboarding] No auth token found, redirecting to login');
        window.location.replace('/login');
      }
    } catch (e) {
      console.error('[Onboarding] Early auth check error:', e);
    }
  </script>

  <noscript>
    <div class="max-w-screen-md mx-auto my-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800">
      JavaScript is required to complete onboarding. Please enable JavaScript and refresh.
    </div>
  </noscript>

  <!-- Loading State: Show while verifying authentication -->
  <div id="loadingState" class="min-h-screen flex items-center justify-center" style="background-color: #1C2434;">
    <div class="text-center">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center" style="background-color: rgba(169, 143, 250, 0.1);">
        <svg class="animate-spin w-8 h-8" style="color: #A98FFA;" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
      <p class="text-lg font-medium" style="color: #FFFFFF;">Verifying your account...</p>
    </div>
  </div>

  <!-- Page Guard: Keep everything hidden until we verify user needs onboarding -->
  <div id="pageGuard" class="hidden">
  
  <!-- Hero Section with Dark Background -->
  <section style="background-color: #1C2434; padding: 6rem 1rem 0;">
    <div class="max-w-3xl mx-auto text-center pb-12">
      <div class="inline-flex items-center gap-2 px-4 py-2 mb-6 rounded-full" style="background: rgba(169, 143, 250, 0.12); border: 1px solid rgba(169, 143, 250, 0.25);">
        <svg class="w-4 h-4" style="color: #C4B3FC;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z" fill="currentColor"/>
        </svg>
        <span class="text-sm font-semibold" style="color: #FFFFFF;">Quick Setup</span>
      </div>
      
      <h1 class="text-4xl sm:text-5xl lg:text-6xl font-black leading-tight mb-4" style="color: #FFFFFF;">
        Welcome to <span class="gradient-highlight">Giveback Guide</span>
      </h1>
      <p class="text-lg sm:text-xl leading-relaxed max-w-2xl mx-auto" style="color: #D1D4D1;">
        Just a few quick questions to personalize your experience and help you discover the perfect ways to make a difference.
      </p>
    </div>
  </section>

  <!-- Form Section -->
  <section style="background: linear-gradient(to bottom, #1C2434 0%, #F6F7F6 20%);">
    <div id="onboardGuard" aria-busy="true" class="max-w-xl mx-auto px-4 pb-24">
      <div class="bg-white rounded-2xl shadow-xl p-8 sm:p-12 border border-gray-200">
        <form id="onboardForm" class="space-y-8">
          <!-- First Name -->
          <div>
            <label for="firstName" class="block text-base font-semibold mb-2" style="color: #1C2434;">
              What should we call you?
            </label>
            <input 
              id="firstName" 
              name="name" 
              type="text" 
              required 
              placeholder="Your first name" 
              class="w-full px-4 py-3.5 text-base rounded-lg transition-all duration-300 focus:outline-none focus:ring-2"
              style="border: 2px solid #E8EAE8; background: #FFFFFF;"
            />
          </div>

          <!-- Newsletter Opt-in -->
          <div class="flex items-start gap-4 p-4 rounded-lg" style="background: #F6F7F6; border: 1px solid #E8EAE8;">
            <input 
              id="newsletter" 
              name="newsletter" 
              type="checkbox" 
              class="w-5 h-5 mt-0.5 rounded cursor-pointer"
              style="accent-color: #A98FFA;"
            />
            <div class="flex-1">
              <label for="newsletter" class="block text-base font-medium cursor-pointer" style="color: #1C2434;">
                Keep me updated
              </label>
              <p class="text-sm mt-1" style="color: #7E827E;">
                Get monthly inspiration, new projects, and travel tips delivered to your inbox.
              </p>
            </div>
          </div>

          <!-- Terms Consent -->
          <div class="flex items-start gap-4">
            <input 
              id="consent" 
              name="consent" 
              type="checkbox" 
              required 
              class="w-5 h-5 mt-0.5 rounded cursor-pointer"
              style="accent-color: #A98FFA;"
            />
            <label for="consent" class="text-sm leading-relaxed cursor-pointer" style="color: #424D62;">
              I agree to the <a href="/terms" class="font-semibold underline hover:no-underline cursor-pointer" style="color: #7353D4;">Terms of Service</a> and <a href="/privacy" class="font-semibold underline hover:no-underline cursor-pointer" style="color: #7353D4;">Privacy Policy</a>
            </label>
          </div>

          <!-- Submit Button -->
          <div class="pt-4">
            <button 
              id="submitBtn" 
              type="submit" 
              class="w-full py-4 px-6 text-base font-semibold text-white rounded-lg transition-all duration-300 hover:shadow-lg hover:translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
              style="background-color: #1C2434;"
            >
              <span class="inline-flex items-center gap-2">
                Continue to Dashboard
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
              </span>
            </button>
          </div>

          <!-- Form Message -->
          <div id="formMessage" class="mt-4 text-center text-sm font-medium hidden"></div>
        </form>
      </div>
    </div>
  </section>
  
  </div><!-- end pageGuard -->
</MainLayout>

<style>
  /* Gradient text highlight for hero */
  .gradient-highlight {
    background: linear-gradient(
      135deg,
      #DED5FD,
      #C4B3FC,
      #A98FFA,
      #C4B3FC,
      #DED5FD
    );
    background-size: 200% 200%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradientShift 4s ease infinite;
    font-weight: 900;
  }

  @keyframes gradientShift {
    0%, 100% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
  }

  /* Input focus state */
  input[type="text"]:focus {
    border-color: #A98FFA !important;
    ring-color: #A98FFA !important;
  }

  /* Button hover state */
  #submitBtn:hover:not(:disabled) {
    background-color: #0F1419;
  }
</style>

<script>
  import { account, getCurrentUser, updateAccountName, updateAccountPreference } from '../../lib/auth';

  const WORKER_URL = 'https://spring-block-2fcc.matt-c4f.workers.dev';

  const form = document.getElementById('onboardForm') as HTMLFormElement | null;
  const firstName = document.getElementById('firstName') as HTMLInputElement | null;
  const newsletter = document.getElementById('newsletter') as HTMLInputElement | null;
  const consent = document.getElementById('consent') as HTMLInputElement | null;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement | null;
  // skip button removed from UI
  const formMessage = document.getElementById('formMessage') as HTMLElement | null;

  const showMessage = (msg: string, isError = false) => {
    if (!formMessage) return;
    formMessage.textContent = msg;
    formMessage.classList.remove('hidden');
    formMessage.classList.toggle('text-red-600', isError);
    formMessage.classList.toggle('text-green-600', !isError);
  };

  // Call MailerLite worker (same pattern as profile page)
  async function callMailerLite(action: 'subscribe' | 'unsubscribe', subscriberId: string | undefined = undefined, email: string | undefined = undefined, name: string | undefined = undefined) {
  const acc = await account();
  const jwtResp: any = await acc.createJWT();
  const jwt = jwtResp?.jwt;
  if (!jwt) throw new Error('Failed to create auth JWT');

    const bodyObj: any = { action };
    if (email) bodyObj.email = String(email).toLowerCase().trim();
    if (name) bodyObj.name = String(name).trim();
    if (subscriberId) bodyObj.subscriberId = subscriberId;

    const resp = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + jwt
      },
      body: JSON.stringify(bodyObj)
    });

    const text = await resp.text();
    try { return { httpStatus: resp.status, ok: resp.ok, raw: JSON.parse(text) }; } catch (e) { return { httpStatus: resp.status, ok: resp.ok, raw: text }; }
  }

  const saveProfileAndMaybeSubscribe = async (nameVal: string, subscribe: boolean) => {
    try {
  // Update name in auth provider
      await updateAccountName(nameVal);
      // Persist newsletter preference
      await updateAccountPreference('newsletter', !!subscribe);

      if (subscribe) {
        // Get current user email
        const user: any = await getCurrentUser();
        const email = user?.email as string | undefined;

        if (!email) {
          showMessage('Saved, but we could not subscribe you because your email was not available client-side. You can subscribe later in your profile.', true);
        } else {
          try {
            const result: any = await callMailerLite('subscribe', undefined, email, nameVal);
            if (!result || !result.ok) {
              console.error('MailerLite subscribe failed', result);
              showMessage('Saved, but newsletter subscription failed. You can update this later in your profile.', true);
            } else {
              const raw = result.raw || {};
              const sid = raw?.subscriberId || raw?.subscriber || raw?.data?.id || raw?.id || null;
              if (sid) {
                try { await updateAccountPreference('ml_subscriber_id', sid); } catch (e) { console.error('Failed to persist ml id', e); }
              }
              showMessage('Subscribed to the newsletter. Redirecting...', false);
            }
          } catch (e: any) {
            console.error('MailerLite subscribe failed', e);
            showMessage('Saved, but newsletter subscription failed. You can update this later in your profile.', true);
          }
        }
      }

  // no-op: profiles upsert removed per configuration

      showMessage('Profile saved. Verifying and redirecting...', false);

      // Wait for the auth provider to reflect updated metadata (avoid race)
      const start = Date.now();
      const timeoutMs = 5000;
      let verified = false;
      while (Date.now() - start < timeoutMs) {
        try {
          const latest = await getCurrentUser();
          if (latest && latest.name && String(latest.name).trim() === String(nameVal).trim()) {
            verified = true;
            break;
          }
        } catch (e) {
          // ignore transient errors
        }
        // small delay
        await new Promise((r) => setTimeout(r, 250));
      }

      if (!verified) {
        console.warn('Profile update not yet reflected in auth session after save; proceeding to dashboard anyway');
      }

      setTimeout(() => window.location.href = '/account/dashboard', 400);
    } catch (err: any) {
      console.error('Onboarding save failed', err);
      showMessage((err && err.message) ? err.message : 'Failed to save profile', true);
    }
  };

  // Simplified: Verify page now routes correctly, so we just need to verify auth and show form
  (async () => {
    console.debug('[Onboarding] Loading user for onboarding form...');
    
    // Simple check with one retry (user should already be authenticated from verify page)
    let user: any = await getCurrentUser().catch(() => null);
    
    if (!user) {
      console.debug('[Onboarding] Initial auth check failed, retrying once...');
      await new Promise(resolve => setTimeout(resolve, 500));
      user = await getCurrentUser().catch(() => null);
    }
    
    if (!user) {
      console.error('[Onboarding] Not authenticated, redirecting to login');
      window.location.replace('/login');
      return;
    }

    console.debug('[Onboarding] User authenticated:', { id: user.id, email: user.email });

    // Prefill if name already present
    if (user.name && firstName) {
      (firstName as HTMLInputElement).value = user.name;
      console.debug('[Onboarding] Pre-filled name field');
    }
    
    // Hide loading state and reveal the onboarding form
    console.debug('[Onboarding] Showing onboarding form');
    const loadingState = document.getElementById('loadingState');
    if (loadingState) {
      loadingState.classList.add('hidden');
    }
    
    const pageGuard = document.getElementById('pageGuard');
    if (pageGuard) {
      pageGuard.classList.remove('hidden');
    }
    
    const formGuard = document.getElementById('onboardGuard');
    if (formGuard) { 
      formGuard.removeAttribute('aria-busy'); 
    }
  })();

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!consent || !(consent as HTMLInputElement).checked) {
        showMessage('You must agree to the terms and privacy policy to continue.', true);
        return;
      }

      const nameVal = firstName ? String((firstName as HTMLInputElement).value).trim() : '';
      if (!nameVal) {
        showMessage('Please enter your first name', true);
        return;
      }

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';
      }

      await saveProfileAndMaybeSubscribe(nameVal, !!(newsletter && (newsletter as HTMLInputElement).checked));

      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Continue';
      }
    });
  }

  // skip button removed
</script>
