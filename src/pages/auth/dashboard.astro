---
import MainLayout from '../../layouts/MainLayout.astro';
---

<MainLayout title="Dashboard">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="p-6"> <!-- flattened container: removed border/background/shadow -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
                <div class="flex items-center gap-4">
                    <div class="rounded-full overflow-hidden w-12 h-12 bg-gray-100 flex items-center justify-center">
                        <!-- avatar populated by JS -->
                        <img id="userAvatar" alt="avatar" class="w-full h-full object-cover hidden" />
                        <svg id="userAvatarPlaceholder" class="w-6 h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11c1.657 0 3-1.343 3-3S17.657 5 16 5s-3 1.343-3 3 1.343 3 3 3zM4 21v-1a4 4 0 014-4h8a4 4 0 014 4v1" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-semibold" id="dashTitle">Dashboard</h1>
                        <a id="dashSubtitle" href="/auth/profile" class="text-sm text-gray-500 hover:underline">Edit your profile</a>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 cursor-pointer">Logout</button>
                </div>
            </div>
            <div class="mb-6">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <!-- Stats row -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="p-4 bg-white rounded-lg flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Saved items</p>
                                <div class="mt-2 text-2xl font-bold" id="savedCount">—</div>
                            </div>
                            <div class="text-sm text-gray-400">Projects & Stays</div>
                        </div>

                        <div class="p-4 bg-white rounded-lg flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Lists</p>
                                <div class="mt-2 text-2xl font-bold" id="listsCount">—</div>
                            </div>
                            <div class="text-sm text-gray-400">Custom collections</div>
                        </div>

                        <div class="p-4 bg-white rounded-lg flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Completed</p>
                                <div class="mt-2 text-2xl font-bold" id="completedCount">—</div>
                            </div>
                            <div class="text-sm text-gray-400">Done items</div>
                        </div>
                    </div>

                </div>

                <!-- My Lists section (separate box) -->
                <div class="p-4 bg-gray-50 rounded-lg mt-6">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="text-lg font-semibold">My Lists</h3>
                                <p class="text-sm text-gray-500">Create lists to save projects and stays for later.</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="flex items-center gap-2 text-sm text-gray-600 select-none">
                                    <input id="hideCompletedToggle" type="checkbox" class="rounded border-gray-300" />
                                    Hide completed
                                </label>
                                <button id="createListBtn" class="px-3 py-2 bg-primary-600 text-white rounded-md cursor-pointer">Create new list</button>
                            </div>
                        </div>

                        <!-- Create form (hidden by default) -->
                        <div id="newListForm" class="hidden mb-4">
                            <div class="flex gap-2">
                                <input id="newListName" type="text" placeholder="List name" class="flex-1 px-3 py-2 border rounded-md" />
                                <button id="addListBtn" class="px-3 py-2 bg-green-600 text-white rounded-md cursor-pointer">Add</button>
                                <button id="cancelListBtn" class="px-3 py-2 bg-gray-200 rounded-md cursor-pointer">Cancel</button>
                            </div>
                        </div>

                        <!-- Lists placeholder -->
                        <div id="listsContainer" class="space-y-3">
                            <div class="p-4 bg-white rounded-lg border border-dashed border-gray-200 text-sm text-gray-500">You don't have any lists yet. Create one to get started.</div>
                        </div>
                </div>

            <!-- Recently completed (separate shaded box) -->
            <div class="p-4 bg-gray-50 rounded-lg mt-6 mb-6" id="recentCompletedBox" hidden>
                <div class="flex items-center justify-between mb-3">
                    <h3 id="recentCompletedTitle" class="text-lg font-semibold cursor-pointer">Recently completed</h3>
                    <button id="recentCompletedToggle" aria-expanded="false" aria-label="Expand section" class="p-1 text-gray-600 hover:text-gray-800 rounded cursor-pointer">
                        <svg class="w-4 h-4 transition-transform rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="recentCompletedContent" class="hidden">
                    <div id="recentCompleted" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                </div>
            </div>

            <div id="userInfo" class="prose prose-sm text-sm text-gray-700">
                Loading...
            </div>
        </div>
    </div>
</MainLayout>

<script>
    import { getCurrentUser, logout } from '../../lib/auth';
    import { getListsWithItems, getSavedCounts, createList, removeItemFromList, deleteList } from '../../lib/lists';
    import { getCompletedCount, getRecentCompleted, getStatusesForItems, setCompleted } from '../../lib/completed';

    // Check if user is logged in
    const checkAuth = async () => {
        const user = await getCurrentUser();
            console.debug('Dashboard auth check user:', user);
            if (!user) {
                console.debug('No user found - redirecting to login');
                window.location.href = '/auth/login';
                return;
            }

        const userInfo = document.getElementById('userInfo');
        if (userInfo) {
            // populate profile summary and header greeting
            const dashSubtitle = document.getElementById('dashSubtitle');
            const dashTitle = document.getElementById('dashTitle');

            // Title: personalise when we have a name
            if (dashTitle) dashTitle.textContent = user.name ? `Hi, ${user.name}` : 'Dashboard';

            // Subtitle: ensure it links to profile (markup already set)
            if (dashSubtitle) dashSubtitle.textContent = 'Edit profile';

            // Fill userInfo with useful summary and a profile action
            userInfo.innerHTML = `
                <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                    <div>
                        <p class="text-sm text-gray-500">Signed in as</p>
                        <p class="text-base font-medium text-gray-900">${user.name || user.email || 'Member'}</p>
                        <p class="text-sm text-gray-500">${user.email || ''}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="/auth/profile" class="px-3 py-2 bg-primary-600 text-white rounded-md cursor-pointer">Edit profile</a>
                    </div>
                </div>
            `;

            // Edit moved to the dedicated profile page; no inline edit here.

            // Danger zone moved to profile page; no delete handlers here.
        }
    };

    // Handle logout
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            try {
                await logout();
                window.location.href = '/auth/login';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        });
    }

    // (profile and delete handlers attached after DOM is populated in checkAuth)

    // Check auth on page load
    checkAuth();

    // --- Client-side lists UI (real data) ---
    const createListBtn = document.getElementById('createListBtn');
    const newListForm = document.getElementById('newListForm');
    const cancelListBtn = document.getElementById('cancelListBtn');
    const addListBtn = document.getElementById('addListBtn');
    const newListName = document.getElementById('newListName');
    const listsContainer = document.getElementById('listsContainer');
    const listsCount = document.getElementById('listsCount');
    const savedCount = document.getElementById('savedCount');
    const completedCountEl = document.getElementById('completedCount');
    const recentCompletedBox = document.getElementById('recentCompletedBox');
    const recentCompletedContent = document.getElementById('recentCompletedContent');
    const recentCompletedEl = document.getElementById('recentCompleted');
    const recentCompletedToggle = document.getElementById('recentCompletedToggle');
    const recentCompletedTitle = document.getElementById('recentCompletedTitle');
    const hideCompletedToggle = document.getElementById('hideCompletedToggle');

    // State
    let lists = [] as any[];
    let indexByKey: Record<string, any> = {};
    let statusByKey: Record<string, any> = {};
    const HIDE_COMPLETED_LS = 'dashHideCompleted';
    let hideCompleted = false;
    try { hideCompleted = localStorage.getItem(HIDE_COMPLETED_LS) === '1'; } catch(_) {}
    if (hideCompletedToggle) (hideCompletedToggle as HTMLInputElement).checked = hideCompleted;

    function idKeysFor(type: 'project' | 'stay', id: string){ return [`${type}:${id}`]; }

    function renderLists(){
        if (!listsContainer) return;
        if (!lists || lists.length === 0){
            listsContainer.innerHTML = '<div class="p-4 bg-white rounded-lg border border-dashed border-gray-200 text-sm text-gray-500">You don\'t have any lists yet. Create one to get started.</div>';
            if (listsCount) listsCount.textContent = '0';
            if (savedCount) savedCount.textContent = '0';
            return;
        }
        listsContainer.innerHTML = '';
        let totalItems = 0;
        lists.forEach(l => { totalItems += (l.items?.length || 0); });
        if (listsCount) listsCount.textContent = String(lists.length);
        if (savedCount) savedCount.textContent = String(totalItems);

        const frag = document.createDocumentFragment();
                lists.forEach(l => {
            const wrap = document.createElement('div');
                        wrap.className = 'p-4 bg-white rounded-lg';
            const count = l.items?.length || 0;
        const lsKey = `dashListCollapsed:${l.id}`;
        const initialCollapsed = typeof localStorage !== 'undefined' && localStorage.getItem(lsKey) === '1';
                        wrap.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                                                <div class="font-medium cursor-pointer" data-list-title>${l.title}${l.is_default ? ' <span class="text-xs text-gray-500">(default)</span>' : ''}</div>
                        <div class="text-sm text-gray-500">${count} item${count===1?'':'s'}</div>
                    </div>
                    <div class="flex items-center gap-2">
                                                                        <button data-toggle-list="${l.id}" aria-expanded="${initialCollapsed ? 'false' : 'true'}" aria-label="${initialCollapsed ? 'Expand list' : 'Collapse list'}" class="p-1 text-gray-600 hover:text-gray-800 rounded cursor-pointer">
                                                    <svg class="w-4 h-4 transition-transform ${initialCollapsed ? 'rotate-180' : ''}" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                                                                                <button data-delete-list="${l.id}" aria-label="Delete list" title="Delete list" class="p-1 text-red-600 hover:text-red-800 rounded hover:bg-red-50 cursor-pointer">
                                                                                                    <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 7h14m-9 3v8m4-8v8M10 3h4a1 1 0 0 1 1 1v3H9V4a1 1 0 0 1 1-1ZM6 7h12v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7Z"/>
                                                                                                    </svg>
                                                                        </button>
                    </div>
                </div>
        <div class="mt-3 space-y-4 ${initialCollapsed ? 'hidden' : ''}" data-items></div>
            `;
            const itemsHost = wrap.querySelector('[data-items]');
            const todo: any[] = [];
            const done: any[] = [];
            (l.items || []).forEach((item: any) => {
                const key = `${item.item_type}:${item.item_id}`;
                const st = statusByKey[key];
                (st && st.is_completed) ? done.push(item) : todo.push(item);
            });

            const renderRow = (item: any, isDone: boolean) => {
                const meta = indexByKey[`${item.item_type}:${item.item_id}`] || null;
                const title = meta?.title || `${item.item_type} ${item.item_id}`;
                const url = meta?.url || (item.item_type === 'project' ? `/projects/${item.item_id}` : `/stays/${item.item_id}`);
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between border rounded-md px-3 py-2';
                row.innerHTML = `
                    <div class="flex items-center gap-3 min-w-0">
                        ${meta?.image ? `<img src="${meta.image}" alt="" class="w-10 h-10 rounded object-cover"/>` :
                        `<div class="w-10 h-10 rounded bg-gray-100 flex items-center justify-center text-xs text-gray-500">${item.item_type}</div>`}
                        <a class="font-medium hover:underline truncate" href="${url}">${title}</a>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <span class="hidden sm:inline text-xs text-gray-400">${new Date(item.added_at).toLocaleDateString?.() || ''}</span>
                        ${isDone
                            ? `<button data-toggle-done data-next="false" data-type="${item.item_type}" data-id="${item.item_id}" class="px-2 py-1 text-xs text-green-700 bg-green-50 rounded hover:bg-green-100 cursor-pointer" title="Mark as not done">Done</button>`
                            : `<button data-toggle-done data-next="true" data-type="${item.item_type}" data-id="${item.item_id}" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 cursor-pointer">Mark as done</button>`}
                        <button data-remove-item data-list="${l.id}" data-type="${item.item_type}" data-id="${item.item_id}" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 cursor-pointer">Remove</button>
                    </div>
                `;
                return row;
            };

            // To do section
            if (todo.length) {
                const sec = document.createElement('div');
                sec.innerHTML = `<div class="text-sm font-semibold text-gray-700">To do <span class="text-gray-400">(${todo.length})</span></div>`;
                const list = document.createElement('div');
                list.className = 'mt-2 space-y-2';
                todo.forEach((it: any) => list.appendChild(renderRow(it, false)));
                sec.appendChild(list);
                itemsHost?.appendChild(sec);
            }

            // Completed section (optional)
            if (!hideCompleted && done.length) {
                const sec = document.createElement('div');
                sec.innerHTML = `<div class="text-sm font-semibold text-gray-700">Completed <span class="text-gray-400">(${done.length})</span></div>`;
                const list = document.createElement('div');
                list.className = 'mt-2 space-y-2';
                done.forEach((it: any) => list.appendChild(renderRow(it, true)));
                sec.appendChild(list);
                itemsHost?.appendChild(sec);
            }
                        // bind delete list
                        const delBtn = wrap.querySelector('button[data-delete-list]');
                        if (delBtn) {
                            delBtn.addEventListener('click', async () => {
                                const id = (delBtn as HTMLButtonElement).getAttribute('data-delete-list');
                                if (!id) return;
                                const ok = window.confirm('Delete this list? All items in it will also be removed. This cannot be undone.');
                                if (!ok) return;
                                try {
                                    await deleteList(id);
                                    await loadAndRender();
                                } catch (e) {
                                    console.error('Delete list failed', e);
                                }
                            });
                        }

                        // bind collapse/expand toggle
                        const toggleBtn = wrap.querySelector('button[data-toggle-list]');
                        const titleEl = wrap.querySelector('[data-list-title]');
                        const doToggle = () => {
                            const isHidden = itemsHost?.classList.contains('hidden');
                            const icon = toggleBtn?.querySelector('svg');
                            if (isHidden) {
                                itemsHost?.classList.remove('hidden');
                                (toggleBtn as HTMLButtonElement)?.setAttribute('aria-expanded', 'true');
                                (toggleBtn as HTMLButtonElement)?.setAttribute('aria-label', 'Collapse list');
                                icon?.classList.remove('rotate-180');
                                try { localStorage.setItem(lsKey, '0'); } catch(_) {}
                            } else {
                                itemsHost?.classList.add('hidden');
                                (toggleBtn as HTMLButtonElement)?.setAttribute('aria-expanded', 'false');
                                (toggleBtn as HTMLButtonElement)?.setAttribute('aria-label', 'Expand list');
                                icon?.classList.add('rotate-180');
                                try { localStorage.setItem(lsKey, '1'); } catch(_) {}
                            }
                        };
                        if (toggleBtn) {
                            toggleBtn.addEventListener('click', doToggle);
                        }
                        if (titleEl) {
                            titleEl.addEventListener('click', doToggle);
                        }
            frag.appendChild(wrap);
        });
        listsContainer.appendChild(frag);

                // delegate remove buttons
                listsContainer.querySelectorAll('button[data-remove-item]').forEach((btn) => {
                    btn.addEventListener('click', async () => {
                        const listId = (btn as HTMLButtonElement).getAttribute('data-list');
                        const type = (btn as HTMLButtonElement).getAttribute('data-type') as 'project' | 'stay' | null;
                        const id = (btn as HTMLButtonElement).getAttribute('data-id');
                        if (!listId || !type || !id) return;
                        const ok = window.confirm('Remove this item from the list?');
                        if (!ok) return;
                        try {
                            await removeItemFromList(listId, type, id);
                            await loadAndRender();
                        } catch (e) {
                            console.error('Remove item failed', e);
                        }
                    });
                });

                // delegate toggle done buttons
                listsContainer.querySelectorAll('button[data-toggle-done]').forEach((btn) => {
                    btn.addEventListener('click', async () => {
                        const type = (btn as HTMLButtonElement).getAttribute('data-type') as 'project' | 'stay' | null;
                        const id = (btn as HTMLButtonElement).getAttribute('data-id');
                        const nextStr = (btn as HTMLButtonElement).getAttribute('data-next');
                        const next = nextStr === 'true';
                        if (!type || !id) return;
                        try {
                            await setCompleted(type, id, next, 'dashboard');
                        } catch (e) {
                            console.error('Toggle done failed', e);
                        }
                        await loadAndRender();
                    });
                });
    }

    async function fetchIndex(){
        try {
            const res = await fetch('/api/items.json');
            if (!res.ok) throw new Error('Failed to load item index');
            const data = await res.json();
            const idx: Record<string, any> = {};
            (data.items || []).forEach((it: any) => {
                idx[`${it.type}:${it.id}`] = it;
                (it.altIds || []).forEach((aid: string) => { idx[`${it.type}:${aid}`] = it; });
            });
            indexByKey = idx;
        } catch (e) {
            console.warn('Item index load failed', e);
            indexByKey = {};
        }
    }

    async function loadAndRender(){
        try {
            // Ensure auth first
            const user = await getCurrentUser();
            if (!user) return; // redirect already handled earlier
            await fetchIndex();
            const counts = await getSavedCounts();
            if (listsCount) listsCount.textContent = String(counts.lists);
            if (savedCount) savedCount.textContent = String(counts.items);
            // Completed count
            try {
                const c = await getCompletedCount();
                if (completedCountEl) completedCountEl.textContent = String(c);
            } catch {}
            // Recent completed
            try {
                const rec = await getRecentCompleted(6);
                if (rec && rec.length && recentCompletedBox && recentCompletedEl) {
                    recentCompletedBox.hidden = false;
                    recentCompletedEl.innerHTML = '';
                    const rf = document.createDocumentFragment();
                    rec.forEach((r: any) => {
                        const mk = `${r.item_type}:${r.item_id}`;
                        const meta = indexByKey[mk] || {};
                        const url = meta?.url || (r.item_type === 'project' ? `/projects/${r.item_id}` : `/stays/${r.item_id}`);
                        const card = document.createElement('a');
                        card.href = url;
                        card.className = 'flex items-center gap-3 p-3 bg-white rounded-lg border hover:border-gray-300';
                        card.innerHTML = `
                            ${meta?.image ? `<img src="${meta.image}" alt="" class="w-12 h-12 rounded object-cover"/>` :
                            `<div class="w-12 h-12 rounded bg-gray-100 flex items-center justify-center text-xs text-gray-500">${r.item_type}</div>`}
                            <div class="min-w-0">
                                <div class="font-medium truncate">${meta?.title || `${r.item_type} ${r.item_id}`}</div>
                                <div class="text-xs text-gray-500">Completed ${new Date(r.completed_at).toLocaleDateString?.() || ''}</div>
                            </div>
                        `;
                        rf.appendChild(card);
                    });
                    recentCompletedEl.appendChild(rf);
                    // Collapse state (hidden by default)
                    const lsKey = 'dashRecentCollapsed';
                    let collapsed = true;
                    try {
                        const v = localStorage.getItem(lsKey);
                        collapsed = v === null ? true : v === '1';
                    } catch {}
                    const apply = (isCollapsed: boolean) => {
                        const icon = recentCompletedToggle?.querySelector('svg');
                        if (isCollapsed) {
                            recentCompletedContent?.classList.add('hidden');
                            (recentCompletedToggle as HTMLButtonElement)?.setAttribute('aria-expanded', 'false');
                            (recentCompletedToggle as HTMLButtonElement)?.setAttribute('aria-label', 'Expand section');
                            icon?.classList.add('rotate-180');
                        } else {
                            recentCompletedContent?.classList.remove('hidden');
                            (recentCompletedToggle as HTMLButtonElement)?.setAttribute('aria-expanded', 'true');
                            (recentCompletedToggle as HTMLButtonElement)?.setAttribute('aria-label', 'Collapse section');
                            icon?.classList.remove('rotate-180');
                        }
                    };
                    apply(collapsed);
                    if (recentCompletedToggle) {
                        (recentCompletedToggle as HTMLButtonElement).onclick = () => {
                            collapsed = !collapsed;
                            try { localStorage.setItem(lsKey, collapsed ? '1' : '0'); } catch {}
                            apply(collapsed);
                        };
                    }
                    if (recentCompletedTitle) {
                        recentCompletedTitle.setAttribute('tabindex', '0');
                        recentCompletedTitle.addEventListener('click', () => {
                            collapsed = !collapsed;
                            try { localStorage.setItem(lsKey, collapsed ? '1' : '0'); } catch {}
                            apply(collapsed);
                        });
                        recentCompletedTitle.addEventListener('keydown', (e: KeyboardEvent) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                collapsed = !collapsed;
                                try { localStorage.setItem(lsKey, collapsed ? '1' : '0'); } catch {}
                                apply(collapsed);
                            }
                        });
                    }
                } else if (recentCompletedBox) {
                    recentCompletedBox.hidden = true;
                }
            } catch {}
            // Lists and completed statuses
            lists = await getListsWithItems();
            const pairs: any[] = [];
            lists.forEach((l: any) => (l.items || []).forEach((it: any) => { pairs.push({ item_type: it.item_type, item_id: String(it.item_id) }); }));
            try { statusByKey = await getStatusesForItems(pairs); } catch { statusByKey = {}; }
            renderLists();
        } catch (e) {
            console.error('Failed loading lists', e);
        }
    }

    if (createListBtn) {
        createListBtn.addEventListener('click', () => {
            newListForm?.classList.remove('hidden');
            (newListName as HTMLInputElement)?.focus();
        });
    }

    if (cancelListBtn) {
        cancelListBtn.addEventListener('click', () => {
            newListForm?.classList.add('hidden');
            (newListName as HTMLInputElement).value = '';
        });
    }

    if (addListBtn) {
        addListBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const name = (newListName as HTMLInputElement).value.trim();
            if (!name) return;
            try {
                await createList(name, null, false);
                (newListName as HTMLInputElement).value = '';
                newListForm?.classList.add('hidden');
                await loadAndRender();
            } catch (err) {
                console.error('Create list failed', err);
            }
        });
    }

    if (hideCompletedToggle) {
        hideCompletedToggle.addEventListener('change', () => {
            hideCompleted = (hideCompletedToggle as HTMLInputElement).checked;
            try { localStorage.setItem(HIDE_COMPLETED_LS, hideCompleted ? '1' : '0'); } catch(_) {}
            renderLists();
        });
    }

    // Initial load
    loadAndRender();
</script>
