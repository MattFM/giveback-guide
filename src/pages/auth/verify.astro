---
import MainLayout from '../../layouts/MainLayout.astro';
---

<MainLayout title="Verifying...">
    <div class="max-w-md mx-auto mt-8 p-6 bg-white rounded-lg shadow-md">
        <div id="status" class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p>Verifying your login...</p>
        </div>
    </div>
</MainLayout>

<script>
    import { account } from '../../lib/appwrite';

    const updateStatus = (message: string, isError = false) => {
        const statusDiv = document.getElementById('status');
        if (statusDiv) {
            statusDiv.innerHTML = `<p class="${isError ? 'text-red-500' : ''}">${message}</p>`;
        }
    };

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    const secret = urlParams.get('secret');

    if (userId && secret) {
        try {
            // Update the Magic URL session
            await account.updateMagicURLSession(userId, secret);
            updateStatus('Login successful! Redirecting...');
            window.location.href = '/auth/dashboard';
        } catch (error) {
            updateStatus('Invalid or expired magic link. Please try again.', true);
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 3000);
        }
    } else {
        updateStatus('Invalid magic link. Please try again.', true);
        setTimeout(() => {
            window.location.href = '/auth/login';
        }, 3000);
    }
</script>
